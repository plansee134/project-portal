<!DOCTYPE html>
<html lang="en" dir="ltr" id="htmlRoot">
<head>
  <meta charset="UTF-8" />
  <title>Project Portal</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Tailwind + Fonts -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    .font-en{font-family:'Inter',sans-serif}
    .font-ar{font-family:'Cairo',sans-serif}
    .gradient-bg{background:linear-gradient(135deg,#eba91e 0%,#2e2e2e 50%,#eba91e 100%);animation:gradientShift 6s ease-in-out infinite}
    @keyframes gradientShift{0%,100%{background:linear-gradient(135deg,#eba91e 0%,#2e2e2e 50%,#eba91e 100%)}50%{background:linear-gradient(135deg,#2e2e2e 0%,#eba91e 50%,#2e2e2e 100%)}}
    .glass-effect{background:rgba(255,255,255,.15);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,.3);box-shadow:0 8px 32px rgba(0,0,0,.1)}
    .card-hover{transition:all .3s ease;border:1px solid rgba(0,0,0,.06)}
    .card-hover:hover{transform:translateY(-6px);box-shadow:0 18px 30px rgba(0,0,0,.12)}
    .progress-ring{transform:rotate(-90deg)}
    .timeline-bar{height:12px;border-radius:6px;overflow:hidden;background:linear-gradient(90deg,#eba91e 0%,#f59e0b 0%,#e5e7eb 0%,#e5e7eb 100%)}
    .financial-progress{background:linear-gradient(135deg,#1e293b 0%,#334155 100%)}
    .backdrop{background:rgba(0,0,0,.35)}
    .ratio-box{position:relative;padding-bottom:56.25%;height:0;overflow:hidden;border-radius:16px;border:1px solid #e5e7eb;background:#f8fafc}
    .ratio-box iframe{position:absolute;top:0;left:0;width:100%;height:100%;border:0;border-radius:16px}
    .toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 14px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.18);z-index:1000;display:none}
  </style>
</head>
<body class="bg-gray-50 min-h-screen font-en">

  <!-- ===================== LOGIN ===================== -->
  <section id="loginScreen" class="min-h-screen gradient-bg flex items-center justify-center p-4">
    <div class="glass-effect rounded-3xl p-8 w-full max-w-md">
      <div class="text-center mb-8">
        <div class="w-20 h-20 bg-white rounded-2xl flex items-center justify-center mx-auto mb-4">
          <svg class="w-10 h-10 text-amber-600" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2 3 7v11a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V7l-7-5z"/></svg>
        </div>
        <h1 class="text-3xl font-extrabold text-white">Project Portal</h1>
        <p class="text-white/90">Client & Manager Web App</p>
      </div>
      <form id="loginForm" class="space-y-5">
        <div>
          <label class="block text-white/90 text-sm mb-1">Username</label>
          <input id="username" type="text" class="w-full px-4 py-3 rounded-xl bg-white/20 border border-white/30 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-white/50" placeholder="Customer Name (SD06) أو AMR" required>
        </div>
        <div>
          <label class="block text-white/90 text-sm mb-1">Password</label>
          <input id="password" type="password" class="w-full px-4 py-3 rounded-xl bg-white/20 border border-white/30 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-white/50" placeholder="Customer code (SD06) أو 123" required>
        </div>
        <label class="flex items-center gap-2 text-white/90 text-sm">
          <input id="rememberMe" type="checkbox" class="w-4 h-4 rounded border-white/30 bg-white/20">
          Remember me
        </label>
        <button class="w-full bg-white text-amber-700 py-3 rounded-xl font-semibold hover:bg-gray-100">Sign In</button>
      </form>
    </div>
  </section>

  <!-- ===================== CLIENT DASHBOARD ===================== -->
  <section id="clientDashboard" class="hidden">
    <!-- Header -->
    <header class="bg-white shadow border-b">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-20 flex items-center justify-between">
        <div class="flex items-center gap-4">
          <div class="w-12 h-12 bg-gradient-to-br from-amber-500 to-yellow-600 rounded-xl flex items-center justify-center">
            <svg class="w-7 h-7 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M4 4a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2H4z"/></svg>
          </div>
          <div>
            <h1 class="text-2xl font-bold bg-gradient-to-r from-amber-600 to-yellow-600 bg-clip-text text-transparent">Client Portal</h1>
            <p class="text-sm text-gray-600">Digital Project Report</p>
          </div>
        </div>
        <div class="flex items-center gap-6">
          <div class="text-right">
            <p id="welcomeUser" class="text-sm font-semibold text-gray-900">Welcome, --</p>
            <p id="customerCode" class="text-xs text-gray-500">Customer Code: --</p>
          </div>
          <button onclick="logout()" class="text-gray-500 hover:text-red-500 p-2 rounded-lg hover:bg-red-50" title="Logout">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0-4-4m4 4H7m6 4v1a3 3 0 0 1-3 3H6a3 3 0 0 1-3-3V7a3 3 0 0 1 3-3h4a3 3 0 0 1 3 3v1"/></svg>
          </button>
        </div>
      </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <!-- Unit card -->
      <div class="bg-gradient-to-br from-white via-amber-50 to-yellow-50 rounded-3xl shadow p-8 mb-8 card-hover border border-amber-200">
        <div class="flex items-center justify-between mb-8">
          <div class="flex items-center gap-4">
            <h2 class="text-3xl font-bold bg-gradient-to-r from-amber-600 to-yellow-600 bg-clip-text text-transparent">Unit Information</h2>
            <div class="flex items-center gap-2 px-3 py-1 bg-green-100 rounded-full">
              <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
              <span class="text-xs font-medium text-green-700">Verified</span>
            </div>
          </div>
          <div class="w-14 h-14 bg-gradient-to-br from-amber-500 to-yellow-600 rounded-xl flex items-center justify-center">
            <svg class="w-7 h-7 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M4 4a1 1 0 0 1-1-1h12a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V4zM3 10a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v6a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1v-6zM14 9a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h2a1 1 0 0 0 1-1v-6a1 1 0 0 0-1-1h-2z"/></svg>
          </div>
        </div>

        <!-- Basic info -->
        <div class="bg-white/80 rounded-2xl p-6 mb-6 border border-amber-200/50 shadow">
          <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
            <svg class="w-5 h-5 text-amber-600" fill="currentColor" viewBox="0 0 20 20"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            Basic Information
          </h3>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div class="bg-gradient-to-br from-amber-50 to-yellow-100 p-4 rounded-xl border border-amber-200">
              <p class="text-xs text-amber-700 mb-1 font-medium uppercase">Compound Name</p>
              <p id="compoundValue" class="font-bold text-gray-900 text-sm">--</p>
            </div>
            <div class="bg-gradient-to-br from-amber-50 to-yellow-100 p-4 rounded-xl border border-amber-200">
              <p class="text-xs text-amber-700 mb-1 font-medium uppercase">Unit Type</p>
              <p id="unitTypeValue" class="font-bold text-gray-900 text-sm">--</p>
            </div>
            <div class="bg-gradient-to-br from-gray-50 to-slate-100 p-4 rounded-xl border">
              <p class="text-xs text-gray-700 mb-1 font-medium uppercase">Unit Number</p>
              <p id="unitNumberValue" class="font-bold text-gray-900 text-sm">--</p>
            </div>
          </div>
        </div>

        <!-- Specs -->
        <div class="bg-white/80 rounded-2xl p-6 border border-amber-200/50 shadow">
          <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
            <svg class="w-5 h-5 text-amber-600" fill="currentColor" viewBox="0 0 20 20"><path d="M3 4a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V4zM3 10a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v6a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1v-6zM14 9a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h2a1 1 0 0 0 1-1v-6a1 1 0 0 0-1-1h-2z"/></svg>
            Property Specifications
          </h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="text-center">
              <div class="bg-gradient-to-br from-amber-100 to-yellow-200 p-6 rounded-xl border border-amber-300">
                <p class="text-xs text-amber-700 mb-1 font-medium uppercase">Number of Floors</p>
                <p id="floorsValue" class="font-bold text-gray-900 text-lg">--</p>
              </div>
            </div>
            <div class="text-center">
              <div class="bg-gradient-to-br from-gray-100 to-slate-200 p-6 rounded-xl border">
                <p class="text-xs text-gray-700 mb-1 font-medium uppercase">Indoor Area</p>
                <p id="indoorAreaValue" class="font-bold text-gray-900 text-lg">--</p>
              </div>
            </div>
            <div class="text-center">
              <div class="bg-gradient-to-br from-amber-100 to-yellow-200 p-6 rounded-xl border border-amber-300">
                <p class="text-xs text-amber-700 mb-1 font-medium uppercase">Outdoor Area</p>
                <p id="outdoorAreaValue" class="font-bold text-gray-900 text-lg">--</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 3D Interactive View -->
      <div id="threeDCard" class="bg-white rounded-3xl shadow p-8 mb-8 card-hover border hidden">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-2xl font-bold text-gray-900">3D Interactive View</h3>
          <div class="flex items-center gap-3">
            <a id="btnOpen3DNew" target="_blank" rel="noopener" class="px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-sm">Open in new tab</a>
            <button id="btnExpand3D" class="px-3 py-2 rounded-lg bg-amber-600 text-white hover:bg-amber-700 text-sm">Expand</button>
          </div>
        </div>
        <div class="ratio-box">
          <iframe id="threeDIframe"
            src=""
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; fullscreen"
            allowfullscreen webkitallowfullscreen mozallowfullscreen>
          </iframe>
          <div id="threeDPlaceholder" class="absolute inset-0 flex items-center justify-center text-gray-500">No 3D view available.</div>
        </div>
      </div>

      <!-- Progress / Timeline / Finance -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
        <!-- Overall Progress -->
        <div class="bg-white rounded-3xl shadow p-8 card-hover">
          <h3 class="text-2xl font-bold text-gray-900 mb-8">Overall Progress</h3>
          <div class="flex items-center justify-center mb-8">
            <div class="relative w-40 h-40">
              <svg class="w-40 h-40 progress-ring">
                <circle cx="80" cy="80" r="70" stroke="#f3f4f6" stroke-width="12" fill="none"></circle>
                <circle id="progressCircle" cx="80" cy="80" r="70" stroke="url(#progressGradient)" stroke-width="12" fill="none" stroke-dasharray="439.82" stroke-dashoffset="439.82" class="transition-all duration-700"></circle>
                <defs>
                  <linearGradient id="progressGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" style="stop-color:#eba91e"/>
                    <stop offset="50%" style="stop-color:#f59e0b"/>
                    <stop offset="100%" style="stop-color:#fbbf24"/>
                  </linearGradient>
                </defs>
              </svg>
              <div class="absolute inset-0 flex flex-col items-center justify-center">
                <span id="progressPercentage" class="text-4xl font-bold bg-gradient-to-r from-amber-600 to-yellow-600 bg-clip-text text-transparent">--%</span>
                <span class="text-sm text-gray-600 mt-1">Completed</span>
              </div>
            </div>
          </div>
          <div class="text-center">
            <div id="projectStatusChip" class="px-6 py-3 rounded-2xl text-sm font-semibold inline-block bg-amber-500/10 text-amber-700">--</div>
            <p id="delayReason" class="text-sm text-gray-600 mt-2">--</p>
          </div>
        </div>

        <!-- Timeline -->
        <div class="bg-white rounded-3xl shadow p-8 card-hover">
          <h3 class="text-2xl font-bold text-gray-900 mb-8">Project Timeline</h3>
          <div class="mb-8">
            <div class="flex justify-between text-xs text-gray-500 mb-2">
              <span id="startLabel">Start</span>
              <span id="currentLabel" class="font-semibold text-amber-600">0% Complete</span>
              <span id="endLabel">End</span>
            </div>
            <div id="timelineBar" class="timeline-bar mb-4"></div>
            <div class="grid grid-cols-2 gap-2 text-xs">
              <div>Contract Start: <b id="contractStartVal">--</b></div>
              <div>Planned End: <b id="plannedEndVal">--</b></div>
              <div>Actual End: <b id="actualEndVal">--</b></div>
              <div>Contract End: <b id="contractEndVal">--</b></div>
            </div>
          </div>
        </div>

        <!-- Financial -->
        <div class="bg-white rounded-3xl shadow p-8 card-hover">
          <h3 class="text-2xl font-bold text-gray-900 mb-8">Financial Summary</h3>
          <div class="mb-8">
            <div class="financial-progress rounded-2xl p-6 text-white relative overflow-hidden">
              <div class="relative z-10">
                <div class="flex justify-between items-center mb-4">
                  <span class="text-sm opacity-90">Total Project Value</span>
                  <span id="totalProjectValue" class="text-2xl font-bold">--</span>
                </div>
                <div class="w-full bg-white/20 rounded-full h-3 mb-4">
                  <div id="paidProgressBar" class="bg-gradient-to-r from-green-400 to-blue-400 h-3 rounded-full shadow" style="width:0%"></div>
                </div>
                <div class="flex justify-between text-xs opacity-90">
                  <span id="paidPercentLabel">-- Paid</span>
                  <span id="remainingPercentLabel">-- Remaining</span>
                </div>
              </div>
            </div>
          </div>
          <div class="space-y-4">
            <div class="bg-gradient-to-r from-green-500 to-emerald-500 text-white p-5 rounded-2xl shadow">
              <p class="text-sm opacity-90 mb-1">Amount Paid</p>
              <p id="amountPaidVal" class="text-2xl font-bold">--</p>
            </div>
            <div class="bg-gradient-to-r from-orange-500 to-red-500 text-white p-5 rounded-2xl shadow">
              <p class="text-sm opacity-90 mb-1">Remaining Balance</p>
              <p id="remainingAmountVal" class="text-2xl font-bold">--</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Work breakdown -->
      <div class="bg-white rounded-3xl shadow p-8 mb-8 card-hover">
        <h3 class="text-3xl font-bold text-gray-900 mb-8">Work Progress Breakdown</h3>
        <div id="workGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
      </div>

      <!-- Team -->
      <div class="bg-white rounded-3xl shadow p-8 card-hover">
        <h3 class="text-3xl font-bold text-gray-900 mb-8">Project Team</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
          <div class="text-center p-6 bg-gradient-to-br from-blue-50 to-indigo-100 rounded-2xl border">
            <h4 id="teamLeaderName" class="font-bold text-gray-900 mb-2 text-lg">--</h4>
            <p class="text-sm text-blue-600 font-medium">Engineering Team Leader</p>
          </div>
          <div class="text-center p-6 bg-gradient-to-br from-green-50 to-emerald-100 rounded-2xl border">
            <h4 id="siteManagerName" class="font-bold text-gray-900 mb-2 text-lg">--</h4>
            <p class="text-sm text-green-600 font-medium">Site Manager</p>
          </div>
          <div class="text-center p-6 bg-gradient-to-br from-purple-50 to-violet-100 rounded-2xl border">
            <h4 id="areaManagerName" class="font-bold text-gray-900 mb-2 text-lg">--</h4>
            <p class="text-sm text-purple-600 font-medium">Area Manager</p>
          </div>
          <div class="text-center p-6 bg-gradient-to-br from-orange-50 to-amber-100 rounded-2xl border">
            <h4 id="accountManagerName" class="font-bold text-gray-900 mb-2 text-lg">--</h4>
            <p class="text-sm text-orange-600 font-medium">Account Manager</p>
          </div>
        </div>
      </div>
    </main>
  </section>

  <!-- ===================== MANAGER DASHBOARD ===================== -->
  <section id="managerDashboard" class="hidden">
    <header class="bg-gradient-to-r from-slate-900 to-gray-800 text-white">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-20 flex items-center justify-between">
        <div class="flex items-center gap-4">
          <div class="w-12 h-12 bg-gradient-to-br from-amber-500 to-orange-600 rounded-xl flex items-center justify-center">
            <svg class="w-7 h-7 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
          </div>
          <div>
            <h1 class="text-2xl font-bold">Manager Dashboard</h1>
            <p class="text-sm text-gray-300">Complete Project Overview</p>
          </div>
        </div>
        <button onclick="logout()" class="text-gray-300 hover:text-red-400 p-2 rounded-lg hover:bg-red-500/10" title="Logout">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0-4-4m4 4H7m6 4v1a3 3 0 0 1-3 3H6a3 3 0 0 1-3-3V7a3 3 0 0 1 3-3h4a3 3 0 0 1 3 3v1"/></svg>
        </button>
      </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8">
      <!-- Stats (clickable filters) -->
      <div id="m_stats" class="grid grid-cols-2 md:grid-cols-5 gap-6"></div>

      <!-- Totals -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-white rounded-2xl shadow p-6">
          <p class="text-sm text-gray-600">Average Progress</p>
          <p id="m_avgProgress" class="text-3xl font-extrabold mt-2">--%</p>
        </div>
        <div class="bg-white rounded-2xl shadow p-6">
          <p class="text-sm text-gray-600">Total Contract Value</p>
          <p id="m_totalValue" class="text-3xl font-extrabold mt-2">--</p>
        </div>
        <div class="bg-white rounded-2xl shadow p-6">
          <p class="text-sm text-gray-600">Total Paid</p>
          <p id="m_totalPaid" class="text-3xl font-extrabold mt-2 text-emerald-600">--</p>
        </div>
      </div>

      <!-- Projects Grid -->
      <div class="bg-white rounded-2xl shadow p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-bold">All Projects</h3>
          <div class="flex items-center gap-3">
            <select id="statusFilter" class="px-3 py-2 border rounded-lg">
              <option value="all">All</option>
              <option value="on-time">On Time</option>
              <option value="delayed">Delayed</option>
              <option value="critical">Critical</option>
              <option value="completed">Completed</option>
            </select>
            <input id="projectSearch" class="px-3 py-2 border rounded-lg w-64" placeholder="Search by client / compound...">
          </div>
        </div>
        <div id="m_projects" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
      </div>
    </main>
  </section>

  <!-- ===================== 3D FULLSCREEN MODAL ===================== -->
  <div id="threeDModal" class="fixed inset-0 hidden items-center justify-center backdrop z-50 p-4">
    <div class="bg-white w-full h-full max-w-7xl rounded-2xl shadow-2xl overflow-hidden flex flex-col">
      <div class="flex items-center justify-between p-3 border-b">
        <h3 class="text-lg font-bold">3D Viewer</h3>
        <div class="flex items-center gap-2">
          <a id="modalOpenNew" target="_blank" rel="noopener" class="px-3 py-1 rounded-lg bg-slate-100 hover:bg-slate-200 text-sm">Open in new tab</a>
          <button class="p-2 hover:bg-gray-100 rounded-lg" onclick="close3DModal()">
            <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>
      </div>
      <div class="flex-1">
        <iframe id="threeDIframeModal" src="" class="w-full h-full border-0"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; fullscreen"
          allowfullscreen webkitallowfullscreen mozallowfullscreen></iframe>
      </div>
    </div>
  </div>

  <!-- ===================== PROJECT MODAL ===================== -->
  <div id="projectModal" class="fixed inset-0 hidden items-center justify-center backdrop z-50 p-4">
    <div class="bg-white w-full max-w-3xl rounded-2xl shadow-2xl overflow-hidden">
      <div class="flex items-center justify-between p-4 border-b">
        <h3 id="pm_title" class="text-lg font-bold">Project Details</h3>
        <button class="p-2 hover:bg-gray-100 rounded-lg" onclick="closeProjectModal()">
          <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div id="pm_body" class="p-6 space-y-6"></div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <!-- ===================== JS ===================== -->
  <script>
    // ===== BACKEND URL =====
    const API_BASE = "https://script.google.com/macros/s/AKfycbwaK1PlV03hISpKjDfw3lN7mghM7w5ZRDZ98JsliukyKJ8cO2x3aBYhGmDIFyDrDWEg/exec";

    // ===== Utils =====
    const rememberKey = 'portalRememberV2';
    const fmtMoney = n => (n==null||n==='') ? '--' : '£' + Number(n).toLocaleString();
    const clampPct = v => {
      const n = Number(String(v ?? 0).toString().replace('%',''));
      if (isNaN(n)) return 0;
      return Math.max(0, Math.min(100, Math.round(n)));
    };
    const statusKey = s => {
      const x = String(s||'').toLowerCase();
      if (x.includes('complete')) return 'completed';
      if (x.includes('critical')) return 'critical';
      if (x.includes('delay')) return 'delayed';
      return 'on-time';
    };
    function showToast(msg){
      const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block';
      setTimeout(()=>t.style.display='none', 2500);
    }

    // ===== Generic API helper (POST JSON) =====
    async function api(action, payload={}){
      const url = API_BASE + "?action=" + encodeURIComponent(action);
      const res = await fetch(url, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload),
        mode: "cors",
        credentials: "omit"
      });
      // حاول نقرأ JSON حتى لو في خطأ
      let data;
      try{ data = await res.json(); }
      catch(e){
        throw new Error("Response is not JSON. تأكد إن الـ Backend بيرجع JSON ومعمول له CORS.");
      }
      if (data && data.error) throw new Error(data.error);
      return data;
    }

    // ===== Auto login =====
    (async function autoLogin(){
      try{
        const saved = JSON.parse(localStorage.getItem(rememberKey) || 'null');
        if (saved && saved.u && saved.p){
          const u = atob(saved.u), p = atob(saved.p);
          const res = await api('authenticate', {username:u, password:p});
          onAuth(res, true, saved);
        }
      }catch(e){ /* ignore */ }
    })();

    // ===== Login form =====
    document.getElementById('loginForm').addEventListener('submit', async e=>{
      e.preventDefault();
      const u = document.getElementById('username').value.trim();
      const p = document.getElementById('password').value.trim();
      const remember = document.getElementById('rememberMe').checked;
      try{
        const res = await api('authenticate', {username:u, password:p});
        onAuth(res, remember, {u:btoa(u), p:btoa(p)});
      }catch(err){
        alert('خطأ في تسجيل الدخول: ' + err.message);
      }
    });

    function onAuth(res, remember, creds){
      if (!res || !res.ok){ alert(res?.error || 'خطأ في تسجيل الدخول'); return; }
      document.getElementById('loginScreen').classList.add('hidden');

      if (remember && creds){ localStorage.setItem(rememberKey, JSON.stringify({ u:creds.u, p:creds.p, role:res.role })); }

      if (res.role === 'manager'){
        document.getElementById('managerDashboard').classList.remove('hidden');
        loadManager();
      } else {
        document.getElementById('clientDashboard').classList.remove('hidden');
        loadClient(res);
      }
    }

    function logout(){
      localStorage.removeItem(rememberKey);
      document.getElementById('clientDashboard').classList.add('hidden');
      document.getElementById('managerDashboard').classList.add('hidden');
      document.getElementById('loginScreen').classList.remove('hidden');
    }

    /*** CLIENT ***/
    async function loadClient(auth){
      try{
        document.getElementById('welcomeUser').textContent = `Welcome, ${auth.name}`;
        document.getElementById('customerCode').textContent = `Customer Code: ${auth.sd06Code || '--'}`;
        const d = await api('getClientReport', { sd06Code:auth.sd06Code, name:auth.name });
        renderClient(d);
      }catch(e){
        alert('تعذر تحميل بيانات العميل: '+e.message);
      }
    }

    function renderClient(d){
      if (!d || !d.ok){ alert('لم يتم العثور على بيانات العميل'); return; }

      // 3D section
      setup3D(d.view3D);

      // Unit
      const u = d.unit || {};
      setTxt('compoundValue', u.compound);
      setTxt('unitTypeValue', u.unitType);
      setTxt('unitNumberValue', u.unitNumber);
      setTxt('floorsValue', u.floors);
      setTxt('indoorAreaValue', u.areaIndoor);
      setTxt('outdoorAreaValue', u.areaOutdoor);
      setTxt('accountManagerName', (u.accountManager || '--'));

      // Execution
      const ex = d.execution || {};
      const completion = clampPct(ex.completion ?? 0);
      animateCircle('progressCircle','progressPercentage',completion);
      setStatusChip(ex.status);
      setTxt('delayReason', ex.delayReason || '');

      // Timeline
      const tl = ex.timeline || {};
      setTxt('contractStartVal', tl.contractStart || '--');
      setTxt('plannedEndVal', tl.plannedEnd || '--');
      setTxt('actualEndVal', tl.actualEnd || '--');
      setTxt('contractEndVal', tl.contractEnd || '--');
      setTimelineBar('timelineBar', timelinePercent(tl.contractStart, tl.plannedEnd));

      // Finance
      const f = ex.finance || {};
      const total = (f.total || f.projectAmount || 0);
      const paid  = (f.downPayments || 0);
      const remaining = Math.max(0, total - paid);
      setTxt('totalProjectValue', fmtMoney(total));
      setTxt('amountPaidVal', fmtMoney(paid));
      setTxt('remainingAmountVal', fmtMoney(remaining));
      const paidPct = total>0 ? Math.round((paid/total)*100) : 0;
      setWidth('paidProgressBar', paidPct);
      setTxt('paidPercentLabel', `${paidPct}% Paid`);
      setTxt('remainingPercentLabel', `${100-paidPct}% Remaining`);

      // Work
      const grid = document.getElementById('workGrid');
      const work = ex.work || {};
      const workList = [
        ['⚡ Electrical', work.elec],
        ['🚿 Plumbing', work.plumb],
        ['❄️ HVAC', work.hvac],
        ['🏗️ Gypsum Board', work.gypsum],
        ['🪵 Woodwork', work.wood],
        ['🧱 Plastering', work.plaster],
        ['🏺 Ceramic & Porcelain', work.ceramic],
        ['💎 Marble', work.marble],
        ['🎨 Painting', work.paint]
      ];
      grid.innerHTML = workList.map(([name,val])=>{
        const v = clampPct(val);
        return `
          <div class="space-y-4 p-4 bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl border">
            <div class="flex justify-between items-center">
              <span class="text-sm font-semibold text-blue-700">${name}</span>
              <span class="text-lg font-bold text-blue-600">${v}%</span>
            </div>
            <div class="w-full bg-blue-200 rounded-full h-4">
              <div class="bg-gradient-to-r from-blue-500 to-indigo-600 h-4 rounded-full" style="width:${v}%"></div>
            </div>
          </div>`;
      }).join('');

      // Team
      const team = ex.team || {};
      setTxt('teamLeaderName', team.teamLeader || '--');
      setTxt('siteManagerName', team.siteManager || '--');
      setTxt('areaManagerName', team.areaManager || '--');
    }

    function setup3D(url){
      const card = document.getElementById('threeDCard');
      const iframe = document.getElementById('threeDIframe');
      const placeholder = document.getElementById('threeDPlaceholder');
      const btnOpen = document.getElementById('btnOpen3DNew');
      const btnExpand = document.getElementById('btnExpand3D');

      const clean = (url||'').trim();
      const ok = /^https?:\/\//i.test(clean);

      if (ok){
        card.classList.remove('hidden');
        iframe.src = clean;
        iframe.classList.remove('hidden');
        placeholder.classList.add('hidden');
        btnOpen.href = clean;
        btnExpand.onclick = ()=> open3DModal(clean);
        // Double click to expand
        iframe.ondblclick = ()=> open3DModal(clean);
      }else{
        card.classList.add('hidden');
        iframe.src = '';
        btnOpen.removeAttribute('href');
        btnExpand.onclick = null;
        iframe.ondblclick = null;
      }
    }

    /*** MANAGER ***/
    let _managerRaw = null;
    document.getElementById('projectSearch').addEventListener('input', onManagerSearch);
    document.getElementById('statusFilter').addEventListener('change', onManagerSearch);
    function onManagerSearch(){
      if (!_managerRaw) return;
      const q = document.getElementById('projectSearch').value.toLowerCase();
      const filter = document.getElementById('statusFilter').value;
      const filtered = _managerRaw.projects.filter(p => {
        const matchesText = (p.client||'').toLowerCase().includes(q) || (p.compound||'').toLowerCase().includes(q);
        const s = statusKey(p.status);
        const matchesStatus = filter==='all' ? true : (s===filter);
        return matchesText && matchesStatus;
      });
      renderManager({..._managerRaw, projects: filtered}, true);
    }
    async function loadManager(){
      try{
        const d = await api('getManagerDashboard', {});
        _managerRaw = d;
        renderManager(d);
      }catch(e){
        alert('تعذر تحميل لوحة المدير: '+e.message);
      }
    }
    function deriveManagerInfo(d){
      const projects = d.projects || [];
      const counts = {onTime:0, delayed:0, critical:0, completed:0};
      projects.forEach(p=>{
        const s = statusKey(p.status);
        if (s==='completed') counts.completed++;
        else if (s==='critical') counts.critical++;
        else if (s==='delayed') counts.delayed++;
        else counts.onTime++;
      });
      const total = projects.length;
      const avgProgress = total? Math.round(projects.reduce((a,p)=>a+(Number(p.progress)||0),0)/total):0;
      const totalValue = projects.reduce((a,p)=>a+(Number(p.value)||0),0);
      const totalPaid  = projects.reduce((a,p)=>a+(Number(p.paid)||0),0);
      return {counts:{...counts,total}, totals:{avgProgress,totalValue,totalPaid}};
    }
    function renderManager(d, skipStatsHandlers=false){
      if (!d || !d.ok){ alert('تعذر تحميل لوحة المدير'); return; }
      const info = deriveManagerInfo(d);
      const c = d.stats || info.counts;
      const t = d.totals || info.totals;

      const blocks = [
        {key:'all', label:'Total Projects', val:info.counts.total, cls:'from-blue-500 to-blue-600'},
        {key:'on-time', label:'On Time', val:c.onTime, cls:'from-emerald-500 to-emerald-600'},
        {key:'delayed', label:'Delayed', val:c.delayed, cls:'from-amber-500 to-amber-600'},
        {key:'critical', label:'Critical', val:c.critical, cls:'from-rose-500 to-rose-600'},
        {key:'completed', label:'Completed', val:c.completed||0, cls:'from-indigo-500 to-indigo-600'}
      ];
      document.getElementById('m_stats').innerHTML = blocks.map(x=>`
        <button data-filter="${x.key}" class="bg-gradient-to-br ${x.cls} rounded-2xl p-6 text-white shadow text-left hover:opacity-95 focus:outline-none focus:ring-2 focus:ring-white/50">
          <div class="text-white/80 text-sm">${x.label}</div>
          <div class="text-3xl font-extrabold">${x.val ?? 0}</div>
        </button>`).join('');

      if (!skipStatsHandlers){
        document.querySelectorAll('#m_stats [data-filter]').forEach(btn=>{
          btn.addEventListener('click', () => {
            document.getElementById('statusFilter').value = btn.dataset.filter==='all' ? 'all' : btn.dataset.filter;
            onManagerSearch();
            window.scrollTo({top: document.getElementById('m_projects').offsetTop - 80, behavior:'smooth'});
          });
        });
      }

      setTxt('m_avgProgress', (t.avgProgress ?? 0) + '%');
      setTxt('m_totalValue', fmtMoney(t.totalValue));
      setTxt('m_totalPaid', fmtMoney(t.totalPaid));

      const grid = document.getElementById('m_projects');
      grid.innerHTML = (d.projects||[]).map(p=>{
        const k = statusKey(p.status);
        const chip = {
          'on-time':'bg-emerald-100 text-emerald-700',
          'delayed':'bg-amber-100 text-amber-700',
          'critical':'bg-rose-100 text-rose-700',
          'completed':'bg-blue-100 text-blue-700'
        }[k] || 'bg-gray-100 text-gray-700';

        return `
          <div class="bg-white rounded-xl shadow p-6 border">
            <div class="flex justify-between items-start mb-4">
              <div>
                <h4 class="font-bold text-gray-900 text-lg">${p.client || '--'}</h4>
                <p class="text-sm text-gray-600">${p.compound || '--'}</p>
              </div>
              <div class="px-3 py-1 rounded-full text-xs font-medium ${chip}">${p.status || 'On Time'}</div>
            </div>
            <div class="mb-4">
              <div class="flex justify-between text-sm mb-2">
                <span class="text-gray-600">Progress</span>
                <span class="font-semibold">${p.progress ?? 0}%</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-3">
                <div class="bg-gradient-to-r from-blue-500 to-indigo-600 h-3 rounded-full" style="width:${p.progress ?? 0}%"></div>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-4 text-sm mb-4">
              <div><p class="text-gray-600">Start</p><p class="font-semibold">${p.startDate || '--'}</p></div>
              <div><p class="text-gray-600">End</p><p class="font-semibold">${p.endDate || '--'}</p></div>
              <div><p class="text-gray-600">Value</p><p class="font-semibold">${fmtMoney(p.value)}</p></div>
              <div><p class="text-gray-600">Paid</p><p class="font-semibold text-green-600">${fmtMoney(p.paid)}</p></div>
            </div>
            <div class="flex gap-2">
              <button class="flex-1 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-sm font-medium"
                      onclick="openProjectDetails('${p.sd06Code || p.id || ''}','${(p.client||'').replace(/'/g,'&#39;')}')">
                View Details
              </button>
            </div>
          </div>`;
      }).join('');
    }

    /*** Project modal ***/
    async function openProjectDetails(sd06Code, clientName){
      if (!sd06Code){ alert('No SD06 Code found for this project.'); return; }
      document.getElementById('pm_title').textContent = `Project Details — ${clientName||''} (SD06 ${sd06Code})`;
      document.getElementById('projectModal').classList.remove('hidden');
      document.getElementById('projectModal').classList.add('flex');

      try{
        const data = await api('getProjectDetails', { sd06Code });
        if (!data || !data.ok){ document.getElementById('pm_body').innerHTML = '<p class="text-red-600">Unable to load details.</p>'; return; }
        const u = data.unit || {}; const ex = data.execution || {}; const tl = ex.timeline || {};
        const paid = (ex.finance?.downPayments || 0);
        const total = (ex.finance?.total || ex.finance?.projectAmount || 0);
        const remain = Math.max(0, total - paid);

        document.getElementById('pm_body').innerHTML = `
          <div class="grid md:grid-cols-2 gap-6">
            <div class="space-y-3">
              <h4 class="font-bold text-gray-900 text-lg">Unit</h4>
              <div class="text-sm text-gray-700"><b>Compound:</b> ${u.compound||'--'}</div>
              <div class="text-sm text-gray-700"><b>Type:</b> ${u.unitType||'--'}</div>
              <div class="text-sm text-gray-700"><b>Number:</b> ${u.unitNumber||'--'}</div>
              <div class="text-sm text-gray-700"><b>Indoor/Outdoor:</b> ${u.areaIndoor||'--'} / ${u.areaOutdoor||'--'}</div>
            </div>
            <div class="space-y-3">
              <h4 class="font-bold text-gray-900 text-lg">Timeline</h4>
              <div class="text-sm text-gray-700"><b>Contract Start:</b> ${tl.contractStart||'--'}</div>
              <div class="text-sm text-gray-700"><b>Planned End:</b> ${tl.plannedEnd||'--'}</div>
              <div class="text-sm text-gray-700"><b>Contract End:</b> ${tl.contractEnd||'--'}</div>
              <div class="text-sm text-gray-700"><b>Status:</b> ${ex.status||'--'}</div>
              <div class="text-sm text-gray-700"><b>Delay Reason:</b> ${ex.delayReason||'--'}</div>
            </div>
          </div>
          <div class="grid md:grid-cols-3 gap-6 mt-6">
            <div class="bg-white border rounded-xl p-4">
              <p class="text-xs text-gray-600">Completion</p>
              <p class="text-2xl font-extrabold">${clampPct(ex.completion||0)}%</p>
            </div>
            <div class="bg-white border rounded-xl p-4">
              <p class="text-xs text-gray-600">Total</p>
              <p class="text-2xl font-extrabold">${fmtMoney(total)}</p>
            </div>
            <div class="bg-white border rounded-xl p-4">
              <p class="text-xs text-gray-600">Remaining</p>
              <p class="text-2xl font-extrabold text-rose-600">${fmtMoney(remain)}</p>
            </div>
          </div>
          <div class="mt-6">
            <h4 class="font-bold text-gray-900 text-lg mb-3">Team</h4>
            <div class="grid md:grid-cols-3 gap-4 text-sm">
              <div class="p-3 bg-slate-50 rounded-lg"><b>Team Leader:</b> ${ex.team?.teamLeader||'--'}</div>
              <div class="p-3 bg-slate-50 rounded-lg"><b>Site Manager:</b> ${ex.team?.siteManager||'--'}</div>
              <div class="p-3 bg-slate-50 rounded-lg"><b>Area Manager:</b> ${ex.team?.areaManager||'--'}</div>
            </div>
          </div>
        `;
      }catch(e){
        document.getElementById('pm_body').innerHTML = '<p class="text-red-600">Error loading details.</p>';
      }
    }
    function closeProjectModal(){
      document.getElementById('projectModal').classList.add('hidden');
      document.getElementById('projectModal').classList.remove('flex');
    }

    /*** 3D modal ***/
    function open3DModal(url){
      const modal = document.getElementById('threeDModal');
      const iframe = document.getElementById('threeDIframeModal');
      document.getElementById('modalOpenNew').href = url;
      iframe.src = url;
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }
    function close3DModal(){
      const modal = document.getElementById('threeDModal');
      const iframe = document.getElementById('threeDIframeModal');
      iframe.src = ''; // stop render
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    /*** UI helpers ***/
    function setTxt(id, v){ const el = document.getElementById(id); if (el) el.textContent = (v ?? '--'); }
    function setWidth(id, p){ const el = document.getElementById(id); if (el) el.style.width = (Math.max(0,Math.min(100,p||0)))+'%'; }
    function animateCircle(circleId, labelId, p){
      const c = document.getElementById(circleId); const l = document.getElementById(labelId);
      const r=70, C=2*Math.PI*r; const target = Math.max(0, Math.min(100, p||0));
      const offset = C - (target/100)*C; if (c) c.style.strokeDashoffset = offset; if (l) l.textContent = target + '%';
    }
    function setTimelineBar(id, p){
      const el = document.getElementById(id); const perc = Math.max(0, Math.min(100, p||0));
      if (el) el.style.background = `linear-gradient(90deg,#eba91e 0%,#f59e0b ${perc}%,#e5e7eb ${perc}%,#e5e7eb 100%)`;
      setTxt('currentLabel', `${perc}% Complete`);
    }
    function timelinePercent(startStr, endStr){
      const s = startStr ? new Date(startStr) : null; const e = endStr ? new Date(endStr) : null;
      if (!s || !e || isNaN(s) || isNaN(e) || e<=s) return 0; const now = new Date();
      const done = Math.min(Math.max(now - s, 0), e - s); return Math.round(done / (e - s) * 100);
    }
    function setStatusChip(status){
      const chip = document.getElementById('projectStatusChip'); if (!chip) return;
      const s = (status||'').toLowerCase(); let cls='bg-emerald-500/10 text-emerald-700', text = 'On Time';
      if (s.includes('complete')){ cls='bg-blue-500/10 text-blue-700'; text='Completed'; }
      else if (s.includes('critical')){ cls='bg-rose-500/10 text-rose-700'; text='Critical'; }
      else if (s.includes('delay')){ cls='bg-amber-500/10 text-amber-700'; text='Delayed'; }
      chip.className = `px-6 py-3 rounded-2xl text-sm font-semibold inline-block ${cls}`; chip.textContent = text;
    }
  </script>
</body>
</html>
